# Workflow name displayed in GitHub Actions UI
name: Attendance Retry Monitor

# Trigger: Runs automatically when another workflow completes
on:
  workflow_run:
    workflows: ["Daily Attendance Bot"]  # Monitor this specific workflow
    types: [completed]                   # Trigger when it finishes (success or failure)

jobs:
  retry-on-failure:
    runs-on: ubuntu-latest  # Use Ubuntu runner for execution
    
    # Condition: Only run if the monitored workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      # Step 1: Wait 60 seconds before retrying to avoid immediate re-execution
      - name: Wait before retry
        run: sleep 60
      
      # Step 2: Intelligent retry logic with maximum attempt limit
      - name: Retry workflow
        uses: actions/github-script@v7  # Use GitHub API via JavaScript
        with:
          script: |
            const maxRetries = 3;              // Maximum retry attempts allowed
            const workflowId = 'attendance.yml'; // Target workflow file to retry
            
            // Fetch recent workflow runs to count failures
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,   // Repository owner
              repo: context.repo.repo,     // Repository name
              workflow_id: workflowId,     // Specific workflow to query
              per_page: 3                  // Limit to 2 most recent runs
            });
            
            // Count consecutive failures from recent runs
            const recentFailures = runs.data.workflow_runs
              .filter(run => run.conclusion === 'failure')
              .length;
            
            // Retry only if under max retry limit
            if (recentFailures <= maxRetries) {
              console.log(`Retrying workflow (attempt ${recentFailures}/${maxRetries})`);
              
              // Trigger the attendance workflow via workflow_dispatch
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowId,
                ref: 'main'  // Branch to run workflow on
              });
            } else {
              console.log(`Max retries (${maxRetries}) reached. Not retrying.`);
            }
  
  # Job to confirm successful workflow execution
  monitor-success:
    runs-on: ubuntu-latest
    
    # Condition: Only run if the monitored workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Log success
        run: echo "âœ“ Attendance workflow completed successfully. Monitoring active."
